<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL to CSV - URLç”»åƒæŠ½å‡ºãƒ„ãƒ¼ãƒ«</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="URL to CSV - URLç”»åƒæŠ½å‡ºãƒ„ãƒ¼ãƒ«" />
    <meta
      property="og:description"
      content="Webãƒšãƒ¼ã‚¸ã®URLã‹ã‚‰ç”»åƒã‚’æŠ½å‡ºã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Net2Sheet Chromeæ‹¡å¼µæ©Ÿèƒ½ã®è£œå®Œãƒ„ãƒ¼ãƒ«ã€‚"
    />
    <meta property="og:image" content="https://aobaiwaki123.github.io/url-to-csv/url-to-csv.png" />
    <meta
      property="og:url"
      content="https://iwakiaoiyou.github.io/url-to-csv/url-to-csv.html"
    />
    <meta property="og:site_name" content="Net2Sheet Tools" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="URL to CSV - URLç”»åƒæŠ½å‡ºãƒ„ãƒ¼ãƒ«" />
    <meta
      name="twitter:description"
      content="Webãƒšãƒ¼ã‚¸ã®URLã‹ã‚‰ç”»åƒã‚’æŠ½å‡ºã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Net2Sheet Chromeæ‹¡å¼µæ©Ÿèƒ½ã®è£œå®Œãƒ„ãƒ¼ãƒ«ã€‚"
    />
    <meta name="twitter:image" content="https://aobaiwaki123.github.io/url-to-csv/url-to-csv.png" />

    <!-- Additional meta tags -->
    <meta
      name="description"
      content="Webãƒšãƒ¼ã‚¸ã®URLã‹ã‚‰ç”»åƒã‚’æŠ½å‡ºã—ã¦CSVãƒ•ã‚¡ã‚¤ãƒ«ã§å‡ºåŠ›ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚Net2Sheet Chromeæ‹¡å¼µæ©Ÿèƒ½ã®è£œå®Œãƒ„ãƒ¼ãƒ«ã€‚"
    />
    <meta
      name="keywords"
      content="URL,CSV,ç”»åƒæŠ½å‡º,Net2Sheet,Chromeæ‹¡å¼µæ©Ÿèƒ½,ç”»åƒç®¡ç†"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 2rem 0;
        text-align: center;
        margin-bottom: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .url-section {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .url-input-group {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }

      .url-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .url-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        font-size: 1rem;
      }

      .btn-primary {
        background: linear-gradient(45deg, #4f46e5, #3b82f6);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(45deg, #f59e0b, #d97706);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .options-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .option-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .controls {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        display: none;
      }

      .controls.show {
        display: block;
      }

      .stats {
        display: flex;
        gap: 2rem;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stat-number {
        font-weight: bold;
        font-size: 1.3rem;
        color: #4f46e5;
      }

      .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
        color: #4f46e5;
      }

      .loading.show {
        display: block;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
      }

      .image-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .image-card.excluded {
        opacity: 0.6;
        background: #f8f8f8;
      }

      .image-preview {
        width: 100%;
        height: 200px;
        object-fit: contain;
        background: #f0f0f0;
        border-bottom: 1px solid #eee;
      }

      .image-preview.error {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 0.9rem;
        background: #f8f8f8;
      }

      .image-info {
        padding: 1rem;
      }

      .image-name-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        margin-bottom: 1rem;
        transition: border-color 0.3s ease;
      }

      .image-name-input:focus {
        outline: none;
        border-color: #4f46e5;
      }

      .image-url {
        font-size: 0.8rem;
        color: #666;
        word-break: break-all;
        margin-bottom: 1rem;
        line-height: 1.4;
      }

      .exclude-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .exclude-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .no-data {
        text-align: center;
        padding: 4rem 2rem;
        color: #999;
        font-size: 1.2rem;
      }

      .error-message {
        background: #fef2f2;
        color: #dc2626;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #dc2626;
      }

      .success-message {
        background: #f0fdf4;
        color: #16a34a;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #16a34a;
      }

      .warning-message {
        background: #fffbeb;
        color: #d97706;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #d97706;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 2rem;
        }

        .url-input-group {
          flex-direction: column;
          align-items: stretch;
        }

        .stats {
          flex-direction: column;
          gap: 1rem;
        }

        .button-group {
          flex-direction: column;
        }

        .image-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ”— URL to CSV</h1>
        <p class="subtitle">Webãƒšãƒ¼ã‚¸ã®URL ã‹ã‚‰ç”»åƒä¸€è¦§ã‚’æŠ½å‡ºã—ã¦CSVã‚’ç”Ÿæˆ</p>
      </header>

      <div class="url-section">
        <h2>ğŸŒ URLå…¥åŠ›</h2>
        <p style="margin-bottom: 1rem; color: #666">
          ç”»åƒã‚’æŠ½å‡ºã—ãŸã„Webãƒšãƒ¼ã‚¸ã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </p>

        <div class="url-input-group">
          <input
            type="url"
            id="urlInput"
            class="url-input"
            placeholder="https://example.com/page"
            aria-label="Webãƒšãƒ¼ã‚¸ã®URL"
          />
          <button id="extractBtn" class="btn btn-primary">ğŸ” ç”»åƒã‚’æŠ½å‡º</button>
        </div>

        <div class="options-section">
          <div class="option-group">
            <input
              type="checkbox"
              id="includeExternal"
              class="checkbox"
              checked
            />
            <label for="includeExternal">å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ç”»åƒã‚‚å«ã‚ã‚‹</label>
          </div>
          <div class="option-group">
            <input type="checkbox" id="includeDataUrls" class="checkbox" />
            <label for="includeDataUrls">Data URLsã‚‚å«ã‚ã‚‹</label>
          </div>
          <div class="option-group">
            <input type="checkbox" id="includeSvg" class="checkbox" />
            <label for="includeSvg">SVGç”»åƒã‚‚å«ã‚ã‚‹</label>
          </div>
          <div class="option-group">
            <input type="checkbox" id="includeGif" class="checkbox" />
            <label for="includeGif">GIFç”»åƒã‚‚å«ã‚ã‚‹</label>
          </div>
          <div class="option-group">
            <input
              type="checkbox"
              id="includeBackground"
              class="checkbox"
              checked
            />
            <label for="includeBackground">èƒŒæ™¯ç”»åƒã‚‚å«ã‚ã‚‹</label>
          </div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        ç”»åƒã‚’æŠ½å‡ºä¸­...
      </div>

      <div class="controls" id="controls">
        <div class="stats">
          <div class="stat-item">
            <span>ğŸ“Š ç·æ•°:</span>
            <span class="stat-number" id="totalCount">0</span>
          </div>
          <div class="stat-item">
            <span>âœ… æœ‰åŠ¹:</span>
            <span class="stat-number" id="validCount">0</span>
          </div>
          <div class="stat-item">
            <span>âŒ é™¤å¤–:</span>
            <span class="stat-number" id="excludedCount">0</span>
          </div>
        </div>
        <div class="button-group">
          <button class="btn btn-warning" id="toggleExcluded">
            ğŸ‘ï¸ é™¤å¤–ç”»åƒã‚’éš ã™/è¡¨ç¤º
          </button>
          <button class="btn btn-success" id="exportCsv">
            ğŸ’¾ CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
        </div>
      </div>

      <div class="no-data" id="noData">
        ğŸŒ URLã‚’å…¥åŠ›ã—ã¦ã€Œç”»åƒã‚’æŠ½å‡ºã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ç”»åƒä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
      </div>

      <div class="image-grid" id="imageGrid"></div>
    </div>

    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let imageData = [];
      let showExcluded = true;
      let currentUrl = "";

      // DOMè¦ç´ ã®å–å¾—
      const urlInput = document.getElementById("urlInput");
      const extractBtn = document.getElementById("extractBtn");
      const loading = document.getElementById("loading");
      const controls = document.getElementById("controls");
      const noData = document.getElementById("noData");
      const imageGrid = document.getElementById("imageGrid");
      const totalCount = document.getElementById("totalCount");
      const validCount = document.getElementById("validCount");
      const excludedCount = document.getElementById("excludedCount");
      const toggleExcludedBtn = document.getElementById("toggleExcluded");
      const exportCsvBtn = document.getElementById("exportCsv");

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¦ç´ 
      const includeExternal = document.getElementById("includeExternal");
      const includeDataUrls = document.getElementById("includeDataUrls");
      const includeSvg = document.getElementById("includeSvg");
      const includeBackground = document.getElementById("includeBackground");

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      extractBtn.addEventListener("click", handleUrlExtraction);
      urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleUrlExtraction();
        }
      });
      toggleExcludedBtn.addEventListener("click", toggleExcludedImages);
      exportCsvBtn.addEventListener("click", exportModifiedCsv);

      /**
       * URLæŠ½å‡ºå‡¦ç†ã®ãƒ¡ã‚¤ãƒ³é–¢æ•°
       */
      async function handleUrlExtraction() {
        const url = urlInput.value.trim();

        if (!url) {
          showError("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        if (!isValidUrl(url)) {
          showError("æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        try {
          showLoading(true);
          showControls(false);
          imageGrid.innerHTML = "";
          currentUrl = url;

          // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showWarning(
            "âš ï¸ CORSåˆ¶é™ã«ã‚ˆã‚Šã€ä¸€éƒ¨ã®Webã‚µã‚¤ãƒˆã‹ã‚‰ã¯ç”»åƒã‚’æŠ½å‡ºã§ããªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚"
          );

          // ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—
          const content = await fetchPageContent(url);
          const extractedImages = extractImagesFromContent(content, url);

          if (extractedImages.length === 0) {
            showError(
              "ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ç”»åƒã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚CORSåˆ¶é™ã¾ãŸã¯ãƒšãƒ¼ã‚¸ã®æ§‹é€ ãŒåŸå› ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
            );
            return;
          }

          imageData = extractedImages.map((img, index) => ({
            id: index,
            originalName: img.name,
            editedName: img.name,
            url: img.url,
            excluded: false,
            alt: img.alt || "",
            size: img.size || "unknown",
          }));

          await renderImages();
          updateStats();
          showControls(true);
          showSuccess(`${imageData.length}ä»¶ã®ç”»åƒã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚`);
        } catch (error) {
          console.error("æŠ½å‡ºã‚¨ãƒ©ãƒ¼:", error);
          showError(`ç”»åƒæŠ½å‡ºã‚¨ãƒ©ãƒ¼: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      /**
       * ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å–å¾—ï¼ˆCORSå¯¾ç­–ï¼‰
       */
      async function fetchPageContent(url) {
        // è¤‡æ•°ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã‚’è©¦è¡Œ
        const proxyServices = [
          // AllOrigins (HTTPSå¯¾å¿œ)
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
          // CORS Anywhere (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—)
          `https://cors-anywhere.herokuapp.com/${url}`,
          // ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆCORSåˆ¶é™ãŒãªã„å ´åˆï¼‰
          url,
        ];

        let lastError;

        for (const proxyUrl of proxyServices) {
          try {
            console.log(`Trying to fetch from: ${proxyUrl}`);

            const response = await fetch(proxyUrl, {
              method: "GET",
              headers: {
                Accept:
                  "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                "User-Agent": "Mozilla/5.0 (compatible; URL-to-CSV-Tool)",
              },
            });

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const data = await response.text();

            // AllOrigins ã®å ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ãƒ©ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹
            if (proxyUrl.includes("allorigins.win")) {
              const jsonResponse = JSON.parse(data);
              return jsonResponse.contents;
            }

            return data;
          } catch (error) {
            console.error(`Failed to fetch via ${proxyUrl}:`, error);
            lastError = error;
            continue;
          }
        }

        throw new Error(
          `ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ${lastError.message}`
        );
      }

      /**
       * HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰ç”»åƒã‚’æŠ½å‡º
       */
      function extractImagesFromContent(htmlContent, baseUrl) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, "text/html");
        const images = [];
        const seenUrls = new Set(); // é‡è¤‡ã‚’é¿ã‘ã‚‹ãŸã‚

        // imgè¦ç´ ã‚’æŠ½å‡º
        const imgElements = doc.querySelectorAll("img");
        imgElements.forEach((img) => {
          const src = img.getAttribute("src");
          if (src && shouldIncludeImage(src)) {
            const absoluteUrl = resolveUrl(src, baseUrl);
            if (absoluteUrl && !seenUrls.has(absoluteUrl)) {
              seenUrls.add(absoluteUrl);
              images.push({
                name: extractFileNameFromUrl(absoluteUrl),
                url: absoluteUrl,
                alt: img.getAttribute("alt") || "",
                type: "img",
              });
            }
          }
        });

        // pictureè¦ç´ å†…ã®sourceè¦ç´ ã‚’æŠ½å‡º
        const pictureElements = doc.querySelectorAll("picture source");
        pictureElements.forEach((source) => {
          const srcset = source.getAttribute("srcset");
          if (srcset) {
            const urls = parseSrcset(srcset);
            urls.forEach((src) => {
              if (shouldIncludeImage(src)) {
                const absoluteUrl = resolveUrl(src, baseUrl);
                if (absoluteUrl && !seenUrls.has(absoluteUrl)) {
                  seenUrls.add(absoluteUrl);
                  images.push({
                    name: extractFileNameFromUrl(absoluteUrl),
                    url: absoluteUrl,
                    alt: "",
                    type: "picture",
                  });
                }
              }
            });
          }
        });

        // èƒŒæ™¯ç”»åƒã®æŠ½å‡ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if (includeBackground.checked) {
          const elementsWithBg = doc.querySelectorAll("*");
          elementsWithBg.forEach((el) => {
            if (el.style && el.style.backgroundImage) {
              const bgImage = el.style.backgroundImage;
              const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
              if (urlMatch && urlMatch[1]) {
                const src = urlMatch[1];
                if (shouldIncludeImage(src)) {
                  const absoluteUrl = resolveUrl(src, baseUrl);
                  if (absoluteUrl && !seenUrls.has(absoluteUrl)) {
                    seenUrls.add(absoluteUrl);
                    images.push({
                      name: extractFileNameFromUrl(absoluteUrl),
                      url: absoluteUrl,
                      alt: "",
                      type: "background",
                    });
                  }
                }
              }
            }
          });
        }

        return images;
      }

      /**
       * ç”»åƒã‚’å«ã‚ã‚‹ã‹ã©ã†ã‹ã®åˆ¤å®š
       */
      function shouldIncludeImage(src) {
        if (!src) return false;

        // Data URLs
        if (!includeDataUrls.checked && src.startsWith("data:")) {
          return false;
        }

        // å¤–éƒ¨ãƒ‰ãƒ¡ã‚¤ãƒ³
        if (!includeExternal.checked) {
          try {
            const srcUrl = new URL(src);
            const baseUrlObj = new URL(currentUrl);
            if (srcUrl.hostname !== baseUrlObj.hostname) {
              return false;
            }
          } catch (e) {
            // URLè§£æã«å¤±æ•—ã—ãŸå ´åˆã¯å«ã‚ã‚‹
          }
        }

        const lowerSrc = src.toLowerCase();

        // SVGãƒ•ã‚¡ã‚¤ãƒ«
        if (includeSvg.checked && lowerSrc.includes("svg")) {
          return false;
        }

        // GIFãƒ•ã‚¡ã‚¤ãƒ«
        if (includeGif.checked && lowerSrc.includes("gif")) {
          return false;
        }

        // ä¸€èˆ¬çš„ãªç”»åƒå½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆSVGä»¥å¤–ï¼‰
        const imageExtensions = [
          ".jpg",
          ".jpeg",
          ".png",
          ".webp",
          ".bmp",
          ".ico",
          ".avif",
        ];
        return (
          imageExtensions.some((ext) => lowerSrc.includes(ext)) ||
          lowerSrc.includes("image")
        );
      }

      /**
       * ç›¸å¯¾URLã‚’çµ¶å¯¾URLã«å¤‰æ›
       */
      function resolveUrl(url, baseUrl) {
        try {
          return new URL(url, baseUrl).href;
        } catch (e) {
          console.warn("URLè§£æ±ºã«å¤±æ•—:", url, baseUrl);
          return null;
        }
      }

      /**
       * srcsetã‹ã‚‰è¤‡æ•°ã®URLã‚’æŠ½å‡º
       */
      function parseSrcset(srcset) {
        return srcset
          .split(",")
          .map((entry) => entry.trim().split(/\s+/)[0])
          .filter((url) => url);
      }

      /**
       * URLã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ½å‡º
       */
      function extractFileNameFromUrl(url) {
        try {
          const urlObj = new URL(url);
          const pathname = urlObj.pathname;
          const fileName = pathname.split("/").pop();

          if (fileName && fileName.includes(".")) {
            return fileName;
          }

          // ãƒ•ã‚¡ã‚¤ãƒ«åãŒå–å¾—ã§ããªã„å ´åˆã¯ã€ãƒ‘ã‚¹ã®æœ€å¾Œã®éƒ¨åˆ†ã‚’ä½¿ç”¨
          return (
            pathname
              .split("/")
              .filter((part) => part)
              .pop() || "image"
          );
        } catch (e) {
          return "image";
        }
      }

      /**
       * URLã®å¦¥å½“æ€§ã‚’ãƒã‚§ãƒƒã‚¯
       */
      function isValidUrl(string) {
        try {
          const url = new URL(string);
          return url.protocol === "http:" || url.protocol === "https:";
        } catch (_) {
          return false;
        }
      }

      /**
       * ç”»åƒä¸€è¦§è¡¨ç¤º
       */
      async function renderImages() {
        imageGrid.innerHTML = "";

        const visibleImages = imageData.filter(
          (img) => showExcluded || !img.excluded
        );

        if (visibleImages.length === 0) {
          imageGrid.innerHTML =
            '<div class="no-data">è¡¨ç¤ºã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        for (const img of visibleImages) {
          const card = createImageCard(img);
          imageGrid.appendChild(card);
        }
      }

      /**
       * ç”»åƒã‚«ãƒ¼ãƒ‰ä½œæˆ
       */
      function createImageCard(img) {
        const card = document.createElement("div");
        card.className = `image-card ${img.excluded ? "excluded" : ""}`;
        card.dataset.id = img.id;

        card.innerHTML = `
          <div class="image-preview-container">
            <img class="image-preview" src="${img.url}" alt="${escapeHtml(
          img.editedName
        )}"
                 onerror="this.className='image-preview error'; this.innerHTML='ğŸ–¼ï¸ ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“';" />
          </div>
          <div class="image-info">
            <input type="text" class="image-name-input" value="${escapeHtml(
              img.editedName
            )}" 
                   placeholder="ç”»åƒåã‚’å…¥åŠ›..." data-id="${img.id}" />
            <div class="image-url">${escapeHtml(img.url)}</div>
            <label class="exclude-checkbox">
              <input type="checkbox" ${
                img.excluded ? "checked" : ""
              } data-id="${img.id}" />
              ğŸš« ã“ã®ç”»åƒã‚’é™¤å¤–ã™ã‚‹
            </label>
          </div>
        `;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
        const nameInput = card.querySelector(".image-name-input");
        const excludeCheckbox = card.querySelector('input[type="checkbox"]');

        nameInput.addEventListener("input", (e) => {
          const imgId = parseInt(e.target.dataset.id);
          const imgItem = imageData.find((item) => item.id === imgId);
          if (imgItem) {
            imgItem.editedName = e.target.value;
          }
        });

        excludeCheckbox.addEventListener("change", (e) => {
          const imgId = parseInt(e.target.dataset.id);
          const imgItem = imageData.find((item) => item.id === imgId);
          if (imgItem) {
            imgItem.excluded = e.target.checked;
            card.className = `image-card ${imgItem.excluded ? "excluded" : ""}`;
            updateStats();
          }
        });

        return card;
      }

      /**
       * çµ±è¨ˆæƒ…å ±æ›´æ–°
       */
      function updateStats() {
        const total = imageData.length;
        const excluded = imageData.filter((img) => img.excluded).length;
        const valid = total - excluded;

        totalCount.textContent = total;
        validCount.textContent = valid;
        excludedCount.textContent = excluded;
      }

      /**
       * é™¤å¤–ç”»åƒã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
       */
      async function toggleExcludedImages() {
        showExcluded = !showExcluded;
        toggleExcludedBtn.textContent = showExcluded
          ? "ğŸ‘ï¸ é™¤å¤–ç”»åƒã‚’éš ã™"
          : "ğŸ‘ï¸ é™¤å¤–ç”»åƒã‚’è¡¨ç¤º";
        await renderImages();
      }

      /**
       * CSVå‡ºåŠ›
       */
      function exportModifiedCsv() {
        const validImages = imageData.filter((img) => !img.excluded);

        if (validImages.length === 0) {
          showError("å‡ºåŠ›ã™ã‚‹ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        try {
          const csvContent = generateCSV(validImages);
          const filename = generateCSVFilename("extracted_images");

          downloadCSV(csvContent, filename);
          showSuccess(
            `CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å: ${filename}\nä»¶æ•°: ${validImages.length}ä»¶`
          );
        } catch (error) {
          showError(`CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      }

      /**
       * CSVç”Ÿæˆ
       */
      function generateCSV(images) {
        const headers = ["ãƒ•ã‚¡ã‚¤ãƒ«å", "URL"];
        const rows = [csvRow(headers)];

        images.forEach((img) => {
          rows.push(csvRow([img.editedName, img.url]));
        });

        return rows.join("\n");
      }

      /**
       * CSVè¡Œç”Ÿæˆï¼ˆã‚¯ã‚©ãƒ¼ãƒˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¯¾å¿œï¼‰
       */
      function csvRow(row) {
        return row
          .map((value) => `"${(value || "").replace(/"/g, '""')}"`)
          .join(",");
      }

      /**
       * CSVãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
       */
      function generateCSVFilename(prefix = "extracted_images") {
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/[T:]/g, "_");
        return `${prefix}_${timestamp}.csv`;
      }

      /**
       * CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
       */
      function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      /**
       * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
       */
      function escapeHtml(unsafe) {
        return (unsafe || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      /**
       * UIçŠ¶æ…‹ç®¡ç†é–¢æ•°
       */
      function showLoading(show) {
        loading.classList.toggle("show", show);
        extractBtn.disabled = show;
        if (show) {
          noData.style.display = "none";
        }
      }

      function showControls(show) {
        controls.classList.toggle("show", show);
        if (!show) {
          noData.style.display = imageData.length === 0 ? "block" : "none";
        } else {
          noData.style.display = "none";
        }
      }

      function showError(message) {
        showMessage(message, "error");
      }

      function showSuccess(message) {
        showMessage(message, "success");
      }

      function showWarning(message) {
        showMessage(message, "warning");
      }

      function showMessage(message, type) {
        const messageEl = document.createElement("div");
        messageEl.className = `${type}-message`;
        messageEl.textContent = message;

        const container = document.querySelector(".container");
        const urlSection = document.querySelector(".url-section");
        container.insertBefore(messageEl, urlSection.nextSibling);

        setTimeout(() => messageEl.remove(), 5000);
      }
    </script>
  </body>
</html>
