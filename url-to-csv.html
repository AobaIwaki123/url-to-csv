<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL to CSV - URLÁîªÂÉèÊäΩÂá∫„ÉÑ„Éº„É´</title>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content="URL to CSV - URLÁîªÂÉèÊäΩÂá∫„ÉÑ„Éº„É´" />
    <meta
      property="og:description"
      content="Web„Éö„Éº„Ç∏„ÅÆURL„Åã„ÇâÁîªÂÉè„ÇíÊäΩÂá∫„Åó„Å¶CSV„Éï„Ç°„Ç§„É´„ÅßÂá∫Âäõ„Åß„Åç„Çã„ÉÑ„Éº„É´„Åß„Åô„ÄÇNet2Sheet ChromeÊã°ÂºµÊ©üËÉΩ„ÅÆË£úÂÆå„ÉÑ„Éº„É´„ÄÇ"
    />
    <meta property="og:image" content="https://aobaiwaki123.github.io/url-to-csv/url-to-csv.png" />
    <meta
      property="og:url"
      content="https://iwakiaoiyou.github.io/url-to-csv/url-to-csv.html"
    />
    <meta property="og:site_name" content="Net2Sheet Tools" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="URL to CSV - URLÁîªÂÉèÊäΩÂá∫„ÉÑ„Éº„É´" />
    <meta
      name="twitter:description"
      content="Web„Éö„Éº„Ç∏„ÅÆURL„Åã„ÇâÁîªÂÉè„ÇíÊäΩÂá∫„Åó„Å¶CSV„Éï„Ç°„Ç§„É´„ÅßÂá∫Âäõ„Åß„Åç„Çã„ÉÑ„Éº„É´„Åß„Åô„ÄÇNet2Sheet ChromeÊã°ÂºµÊ©üËÉΩ„ÅÆË£úÂÆå„ÉÑ„Éº„É´„ÄÇ"
    />
    <meta name="twitter:image" content="https://aobaiwaki123.github.io/url-to-csv/url-to-csv.png" />

    <!-- Additional meta tags -->
    <meta
      name="description"
      content="Web„Éö„Éº„Ç∏„ÅÆURL„Åã„ÇâÁîªÂÉè„ÇíÊäΩÂá∫„Åó„Å¶CSV„Éï„Ç°„Ç§„É´„ÅßÂá∫Âäõ„Åß„Åç„Çã„ÉÑ„Éº„É´„Åß„Åô„ÄÇNet2Sheet ChromeÊã°ÂºµÊ©üËÉΩ„ÅÆË£úÂÆå„ÉÑ„Éº„É´„ÄÇ"
    />
    <meta
      name="keywords"
      content="URL,CSV,ÁîªÂÉèÊäΩÂá∫,Net2Sheet,ChromeÊã°ÂºµÊ©üËÉΩ,ÁîªÂÉèÁÆ°ÁêÜ"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        color: white;
        padding: 2rem 0;
        text-align: center;
        margin-bottom: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .url-section {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .url-input-group {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-bottom: 1rem;
      }

      .url-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .url-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        font-size: 1rem;
      }

      .btn-primary {
        background: linear-gradient(45deg, #4f46e5, #3b82f6);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(45deg, #f59e0b, #d97706);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .options-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .option-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .controls {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        display: none;
      }

      .controls.show {
        display: block;
      }

      .stats {
        display: flex;
        gap: 2rem;
        font-size: 1.1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stat-number {
        font-weight: bold;
        font-size: 1.3rem;
        color: #4f46e5;
      }

      .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
        color: #4f46e5;
      }

      .loading.show {
        display: block;
      }

      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
      }

      .image-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .image-card.excluded {
        opacity: 0.6;
        background: #f8f8f8;
      }

      .image-preview {
        width: 100%;
        height: 200px;
        object-fit: contain;
        background: #f0f0f0;
        border-bottom: 1px solid #eee;
      }

      .image-preview.error {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 0.9rem;
        background: #f8f8f8;
      }

      .image-info {
        padding: 1rem;
      }

      .image-name-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        margin-bottom: 1rem;
        transition: border-color 0.3s ease;
      }

      .image-name-input:focus {
        outline: none;
        border-color: #4f46e5;
      }

      .image-url {
        font-size: 0.8rem;
        color: #666;
        word-break: break-all;
        margin-bottom: 1rem;
        line-height: 1.4;
      }

      .exclude-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .exclude-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .no-data {
        text-align: center;
        padding: 4rem 2rem;
        color: #999;
        font-size: 1.2rem;
      }

      .error-message {
        background: #fef2f2;
        color: #dc2626;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #dc2626;
      }

      .success-message {
        background: #f0fdf4;
        color: #16a34a;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #16a34a;
      }

      .warning-message {
        background: #fffbeb;
        color: #d97706;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #d97706;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 2rem;
        }

        .url-input-group {
          flex-direction: column;
          align-items: stretch;
        }

        .stats {
          flex-direction: column;
          gap: 1rem;
        }

        .button-group {
          flex-direction: column;
        }

        .image-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üîó URL to CSV</h1>
        <p class="subtitle">Web„Éö„Éº„Ç∏„ÅÆURL „Åã„ÇâÁîªÂÉè‰∏ÄË¶ß„ÇíÊäΩÂá∫„Åó„Å¶CSV„ÇíÁîüÊàê</p>
      </header>

      <div class="url-section">
        <h2>üåê URLÂÖ•Âäõ</h2>
        <p style="margin-bottom: 1rem; color: #666">
          ÁîªÂÉè„ÇíÊäΩÂá∫„Åó„Åü„ÅÑWeb„Éö„Éº„Ç∏„ÅÆURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
        </p>

        <div class="url-input-group">
          <input
            type="url"
            id="urlInput"
            class="url-input"
            placeholder="https://example.com/page"
            aria-label="Web„Éö„Éº„Ç∏„ÅÆURL"
          />
          <button id="extractBtn" class="btn btn-primary">üîç ÁîªÂÉè„ÇíÊäΩÂá∫</button>
        </div>

        <div class="options-section">
          <div class="option-group">
            <input
              type="checkbox"
              id="includeExternal"
              class="checkbox"
              checked
            />
            <label for="includeExternal">Â§ñÈÉ®„Éâ„É°„Ç§„É≥„ÅÆÁîªÂÉè„ÇÇÂê´„ÇÅ„Çã</label>
          </div>
          <div class="option-group">
            <input type="checkbox" id="includeDataUrls" class="checkbox" />
            <label for="includeDataUrls">Data URLs„ÇÇÂê´„ÇÅ„Çã</label>
          </div>
          <div class="option-group">
            <input type="checkbox" id="includeSvg" class="checkbox" />
            <label for="includeSvg">SVGÁîªÂÉè„ÇÇÂê´„ÇÅ„Çã</label>
          </div>
          <div class="option-group">
            <input type="checkbox" id="includeGif" class="checkbox" />
            <label for="includeGif">GIFÁîªÂÉè„ÇÇÂê´„ÇÅ„Çã</label>
          </div>
          <div class="option-group">
            <input
              type="checkbox"
              id="includeBackground"
              class="checkbox"
              checked
            />
            <label for="includeBackground">ËÉåÊôØÁîªÂÉè„ÇÇÂê´„ÇÅ„Çã</label>
          </div>
        </div>
      </div>

      <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        ÁîªÂÉè„ÇíÊäΩÂá∫‰∏≠...
      </div>

      <div class="controls" id="controls">
        <div class="stats">
          <div class="stat-item">
            <span>üìä Á∑èÊï∞:</span>
            <span class="stat-number" id="totalCount">0</span>
          </div>
          <div class="stat-item">
            <span>‚úÖ ÊúâÂäπ:</span>
            <span class="stat-number" id="validCount">0</span>
          </div>
          <div class="stat-item">
            <span>‚ùå Èô§Â§ñ:</span>
            <span class="stat-number" id="excludedCount">0</span>
          </div>
        </div>
        <div class="button-group">
          <button class="btn btn-warning" id="toggleExcluded">
            üëÅÔ∏è Èô§Â§ñÁîªÂÉè„ÇíÈö†„Åô/Ë°®Á§∫
          </button>
          <button class="btn btn-success" id="exportCsv">
            üíæ CSV„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
          </button>
        </div>
      </div>

      <div class="no-data" id="noData">
        üåê URL„ÇíÂÖ•Âäõ„Åó„Å¶„ÄåÁîªÂÉè„ÇíÊäΩÂá∫„Äç„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÁîªÂÉè‰∏ÄË¶ß„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô
      </div>

      <div class="image-grid" id="imageGrid"></div>
    </div>

    <script>
      // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
      let imageData = [];
      let showExcluded = true;
      let currentUrl = "";

      // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
      const urlInput = document.getElementById("urlInput");
      const extractBtn = document.getElementById("extractBtn");
      const loading = document.getElementById("loading");
      const controls = document.getElementById("controls");
      const noData = document.getElementById("noData");
      const imageGrid = document.getElementById("imageGrid");
      const totalCount = document.getElementById("totalCount");
      const validCount = document.getElementById("validCount");
      const excludedCount = document.getElementById("excludedCount");
      const toggleExcludedBtn = document.getElementById("toggleExcluded");
      const exportCsvBtn = document.getElementById("exportCsv");

      // „Ç™„Éó„Ç∑„Éß„É≥Ë¶ÅÁ¥†
      const includeExternal = document.getElementById("includeExternal");
      const includeDataUrls = document.getElementById("includeDataUrls");
      const includeSvg = document.getElementById("includeSvg");
      const includeBackground = document.getElementById("includeBackground");

      // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
      extractBtn.addEventListener("click", handleUrlExtraction);
      urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          handleUrlExtraction();
        }
      });
      toggleExcludedBtn.addEventListener("click", toggleExcludedImages);
      exportCsvBtn.addEventListener("click", exportModifiedCsv);

      /**
       * URLÊäΩÂá∫Âá¶ÁêÜ„ÅÆ„É°„Ç§„É≥Èñ¢Êï∞
       */
      async function handleUrlExtraction() {
        const url = urlInput.value.trim();

        if (!url) {
          showError("URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          return;
        }

        if (!isValidUrl(url)) {
          showError("ÊúâÂäπ„Å™URL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
          return;
        }

        try {
          showLoading(true);
          showControls(false);
          imageGrid.innerHTML = "";
          currentUrl = url;

          // Ë≠¶Âëä„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
          showWarning(
            "‚ö†Ô∏è CORSÂà∂Èôê„Å´„Çà„Çä„ÄÅ‰∏ÄÈÉ®„ÅÆWeb„Çµ„Ç§„Éà„Åã„Çâ„ÅØÁîªÂÉè„ÇíÊäΩÂá∫„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ"
          );

          // „Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éì„Çπ„Çí‰ΩøÁî®„Åó„Å¶„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÂèñÂæó
          const content = await fetchPageContent(url);
          const extractedImages = extractImagesFromContent(content, url);

          if (extractedImages.length === 0) {
            showError(
              "„Åì„ÅÆ„Éö„Éº„Ç∏„Åã„ÇâÁîªÂÉè„ÇíÊäΩÂá∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇCORSÂà∂Èôê„Åæ„Åü„ÅØ„Éö„Éº„Ç∏„ÅÆÊßãÈÄ†„ÅåÂéüÂõ†„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ"
            );
            return;
          }

          imageData = extractedImages.map((img, index) => ({
            id: index,
            originalName: img.name,
            editedName: img.name,
            url: img.url,
            excluded: false,
            alt: img.alt || "",
            size: img.size || "unknown",
          }));

          await renderImages();
          updateStats();
          showControls(true);
          showSuccess(`${imageData.length}‰ª∂„ÅÆÁîªÂÉè„ÇíÊäΩÂá∫„Åó„Åæ„Åó„Åü„ÄÇ`);
        } catch (error) {
          console.error("ÊäΩÂá∫„Ç®„É©„Éº:", error);
          showError(`ÁîªÂÉèÊäΩÂá∫„Ç®„É©„Éº: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      /**
       * „Éö„Éº„Ç∏„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂèñÂæóÔºàCORSÂØæÁ≠ñÔºâ
       */
      async function fetchPageContent(url) {
        // Ë§áÊï∞„ÅÆ„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éì„Çπ„ÇíË©¶Ë°å
        const proxyServices = [
          // AllOrigins (HTTPSÂØæÂøú)
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
          // CORS Anywhere („Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó)
          `https://cors-anywhere.herokuapp.com/${url}`,
          // Áõ¥Êé•„Ç¢„ÇØ„Çª„ÇπÔºàCORSÂà∂Èôê„Åå„Å™„ÅÑÂ†¥ÂêàÔºâ
          url,
        ];

        let lastError;

        for (const proxyUrl of proxyServices) {
          try {
            console.log(`Trying to fetch from: ${proxyUrl}`);

            const response = await fetch(proxyUrl, {
              method: "GET",
              headers: {
                Accept:
                  "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                "User-Agent": "Mozilla/5.0 (compatible; URL-to-CSV-Tool)",
              },
            });

            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`
              );
            }

            const data = await response.text();

            // AllOrigins „ÅÆÂ†¥Âêà„ÄÅ„É¨„Çπ„Éù„É≥„Çπ„ÅåJSON„Åß„É©„ÉÉ„Éó„Åï„Çå„Å¶„ÅÑ„Çã
            if (proxyUrl.includes("allorigins.win")) {
              const jsonResponse = JSON.parse(data);
              return jsonResponse.contents;
            }

            return data;
          } catch (error) {
            console.error(`Failed to fetch via ${proxyUrl}:`, error);
            lastError = error;
            continue;
          }
        }

        throw new Error(
          `„Åô„Åπ„Å¶„ÅÆ„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éì„Çπ„Åß„Ç¢„ÇØ„Çª„Çπ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${lastError.message}`
        );
      }

      /**
       * HTML„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Åã„ÇâÁîªÂÉè„ÇíÊäΩÂá∫
       */
      function extractImagesFromContent(htmlContent, baseUrl) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, "text/html");
        const images = [];
        const seenUrls = new Set(); // ÈáçË§á„ÇíÈÅø„Åë„Çã„Åü„ÇÅ

        // imgË¶ÅÁ¥†„ÇíÊäΩÂá∫
        const imgElements = doc.querySelectorAll("img");
        imgElements.forEach((img) => {
          const src = img.getAttribute("src");
          if (src && shouldIncludeImage(src)) {
            const absoluteUrl = resolveUrl(src, baseUrl);
            if (absoluteUrl && !seenUrls.has(absoluteUrl)) {
              seenUrls.add(absoluteUrl);
              images.push({
                name: extractFileNameFromUrl(absoluteUrl),
                url: absoluteUrl,
                alt: img.getAttribute("alt") || "",
                type: "img",
              });
            }
          }
        });

        // pictureË¶ÅÁ¥†ÂÜÖ„ÅÆsourceË¶ÅÁ¥†„ÇíÊäΩÂá∫
        const pictureElements = doc.querySelectorAll("picture source");
        pictureElements.forEach((source) => {
          const srcset = source.getAttribute("srcset");
          if (srcset) {
            const urls = parseSrcset(srcset);
            urls.forEach((src) => {
              if (shouldIncludeImage(src)) {
                const absoluteUrl = resolveUrl(src, baseUrl);
                if (absoluteUrl && !seenUrls.has(absoluteUrl)) {
                  seenUrls.add(absoluteUrl);
                  images.push({
                    name: extractFileNameFromUrl(absoluteUrl),
                    url: absoluteUrl,
                    alt: "",
                    type: "picture",
                  });
                }
              }
            });
          }
        });

        // ËÉåÊôØÁîªÂÉè„ÅÆÊäΩÂá∫Ôºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
        if (includeBackground.checked) {
          const elementsWithBg = doc.querySelectorAll("*");
          elementsWithBg.forEach((el) => {
            if (el.style && el.style.backgroundImage) {
              const bgImage = el.style.backgroundImage;
              const urlMatch = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
              if (urlMatch && urlMatch[1]) {
                const src = urlMatch[1];
                if (shouldIncludeImage(src)) {
                  const absoluteUrl = resolveUrl(src, baseUrl);
                  if (absoluteUrl && !seenUrls.has(absoluteUrl)) {
                    seenUrls.add(absoluteUrl);
                    images.push({
                      name: extractFileNameFromUrl(absoluteUrl),
                      url: absoluteUrl,
                      alt: "",
                      type: "background",
                    });
                  }
                }
              }
            }
          });
        }

        return images;
      }

      /**
       * ÁîªÂÉè„ÇíÂê´„ÇÅ„Çã„Åã„Å©„ÅÜ„Åã„ÅÆÂà§ÂÆö
       */
      function shouldIncludeImage(src) {
        if (!src) return false;

        // Data URLs
        if (!includeDataUrls.checked && src.startsWith("data:")) {
          return false;
        }

        // Â§ñÈÉ®„Éâ„É°„Ç§„É≥
        if (!includeExternal.checked) {
          try {
            const srcUrl = new URL(src);
            const baseUrlObj = new URL(currentUrl);
            if (srcUrl.hostname !== baseUrlObj.hostname) {
              return false;
            }
          } catch (e) {
            // URLËß£Êûê„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂê´„ÇÅ„Çã
          }
        }

        const lowerSrc = src.toLowerCase();

        // SVG„Éï„Ç°„Ç§„É´
        if (includeSvg.checked && lowerSrc.includes("svg")) {
          return false;
        }

        // GIF„Éï„Ç°„Ç§„É´
        if (includeGif.checked && lowerSrc.includes("gif")) {
          return false;
        }

        // ‰∏ÄËà¨ÁöÑ„Å™ÁîªÂÉèÂΩ¢Âºè„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàSVG‰ª•Â§ñÔºâ
        const imageExtensions = [
          ".jpg",
          ".jpeg",
          ".png",
          ".webp",
          ".bmp",
          ".ico",
          ".avif",
        ];
        return (
          imageExtensions.some((ext) => lowerSrc.includes(ext)) ||
          lowerSrc.includes("image")
        );
      }

      /**
       * Áõ∏ÂØæURL„ÇíÁµ∂ÂØæURL„Å´Â§âÊèõ
       */
      function resolveUrl(url, baseUrl) {
        try {
          return new URL(url, baseUrl).href;
        } catch (e) {
          console.warn("URLËß£Ê±∫„Å´Â§±Êïó:", url, baseUrl);
          return null;
        }
      }

      /**
       * srcset„Åã„ÇâË§áÊï∞„ÅÆURL„ÇíÊäΩÂá∫
       */
      function parseSrcset(srcset) {
        return srcset
          .split(",")
          .map((entry) => entry.trim().split(/\s+/)[0])
          .filter((url) => url);
      }

      /**
       * URL„Åã„Çâ„Éï„Ç°„Ç§„É´Âêç„ÇíÊäΩÂá∫
       */
      function extractFileNameFromUrl(url) {
        try {
          const urlObj = new URL(url);
          const pathname = urlObj.pathname;
          const fileName = pathname.split("/").pop();

          if (fileName && fileName.includes(".")) {
            return fileName;
          }

          // „Éï„Ç°„Ç§„É´Âêç„ÅåÂèñÂæó„Åß„Åç„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Éë„Çπ„ÅÆÊúÄÂæå„ÅÆÈÉ®ÂàÜ„Çí‰ΩøÁî®
          return (
            pathname
              .split("/")
              .filter((part) => part)
              .pop() || "image"
          );
        } catch (e) {
          return "image";
        }
      }

      /**
       * URL„ÅÆÂ¶•ÂΩìÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ
       */
      function isValidUrl(string) {
        try {
          const url = new URL(string);
          return url.protocol === "http:" || url.protocol === "https:";
        } catch (_) {
          return false;
        }
      }

      /**
       * ÁîªÂÉè‰∏ÄË¶ßË°®Á§∫
       */
      async function renderImages() {
        imageGrid.innerHTML = "";

        const visibleImages = imageData.filter(
          (img) => showExcluded || !img.excluded
        );

        if (visibleImages.length === 0) {
          imageGrid.innerHTML =
            '<div class="no-data">Ë°®Á§∫„Åô„ÇãÁîªÂÉè„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
          return;
        }

        for (const img of visibleImages) {
          const card = createImageCard(img);
          imageGrid.appendChild(card);
        }
      }

      /**
       * ÁîªÂÉè„Ç´„Éº„Éâ‰ΩúÊàê
       */
      function createImageCard(img) {
        const card = document.createElement("div");
        card.className = `image-card ${img.excluded ? "excluded" : ""}`;
        card.dataset.id = img.id;

        card.innerHTML = `
          <div class="image-preview-container">
            <img class="image-preview" src="${img.url}" alt="${escapeHtml(
          img.editedName
        )}"
                 onerror="this.className='image-preview error'; this.innerHTML='üñºÔ∏è ÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì';" />
          </div>
          <div class="image-info">
            <input type="text" class="image-name-input" value="${escapeHtml(
              img.editedName
            )}" 
                   placeholder="ÁîªÂÉèÂêç„ÇíÂÖ•Âäõ..." data-id="${img.id}" />
            <div class="image-url">${escapeHtml(img.url)}</div>
            <label class="exclude-checkbox">
              <input type="checkbox" ${
                img.excluded ? "checked" : ""
              } data-id="${img.id}" />
              üö´ „Åì„ÅÆÁîªÂÉè„ÇíÈô§Â§ñ„Åô„Çã
            </label>
          </div>
        `;

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºËøΩÂä†
        const nameInput = card.querySelector(".image-name-input");
        const excludeCheckbox = card.querySelector('input[type="checkbox"]');

        nameInput.addEventListener("input", (e) => {
          const imgId = parseInt(e.target.dataset.id);
          const imgItem = imageData.find((item) => item.id === imgId);
          if (imgItem) {
            imgItem.editedName = e.target.value;
          }
        });

        excludeCheckbox.addEventListener("change", (e) => {
          const imgId = parseInt(e.target.dataset.id);
          const imgItem = imageData.find((item) => item.id === imgId);
          if (imgItem) {
            imgItem.excluded = e.target.checked;
            card.className = `image-card ${imgItem.excluded ? "excluded" : ""}`;
            updateStats();
          }
        });

        return card;
      }

      /**
       * Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
       */
      function updateStats() {
        const total = imageData.length;
        const excluded = imageData.filter((img) => img.excluded).length;
        const valid = total - excluded;

        totalCount.textContent = total;
        validCount.textContent = valid;
        excludedCount.textContent = excluded;
      }

      /**
       * Èô§Â§ñÁîªÂÉè„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
       */
      async function toggleExcludedImages() {
        showExcluded = !showExcluded;
        toggleExcludedBtn.textContent = showExcluded
          ? "üëÅÔ∏è Èô§Â§ñÁîªÂÉè„ÇíÈö†„Åô"
          : "üëÅÔ∏è Èô§Â§ñÁîªÂÉè„ÇíË°®Á§∫";
        await renderImages();
      }

      /**
       * CSVÂá∫Âäõ
       */
      function exportModifiedCsv() {
        const validImages = imageData.filter((img) => !img.excluded);

        if (validImages.length === 0) {
          showError("Âá∫Âäõ„Åô„ÇãÁîªÂÉè„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
          return;
        }

        try {
          const csvContent = generateCSV(validImages);
          const filename = generateCSVFilename("extracted_images");

          downloadCSV(csvContent, filename);
          showSuccess(
            `CSV„ÇíÂá∫Âäõ„Åó„Åæ„Åó„Åü„ÄÇ\n„Éï„Ç°„Ç§„É´Âêç: ${filename}\n‰ª∂Êï∞: ${validImages.length}‰ª∂`
          );
        } catch (error) {
          showError(`CSVÂá∫Âäõ„Ç®„É©„Éº: ${error.message}`);
        }
      }

      /**
       * CSVÁîüÊàê
       */
      function generateCSV(images) {
        const headers = ["„Éï„Ç°„Ç§„É´Âêç", "URL"];
        const rows = [csvRow(headers)];

        images.forEach((img) => {
          rows.push(csvRow([img.editedName, img.url]));
        });

        return rows.join("\n");
      }

      /**
       * CSVË°åÁîüÊàêÔºà„ÇØ„Ç©„Éº„Éà„Ç®„Çπ„Ç±„Éº„ÉóÂØæÂøúÔºâ
       */
      function csvRow(row) {
        return row
          .map((value) => `"${(value || "").replace(/"/g, '""')}"`)
          .join(",");
      }

      /**
       * CSV„Éï„Ç°„Ç§„É´ÂêçÁîüÊàê
       */
      function generateCSVFilename(prefix = "extracted_images") {
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/[T:]/g, "_");
        return `${prefix}_${timestamp}.csv`;
      }

      /**
       * CSV„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
       */
      function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      /**
       * HTML„Ç®„Çπ„Ç±„Éº„Éó
       */
      function escapeHtml(unsafe) {
        return (unsafe || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      /**
       * UIÁä∂ÊÖãÁÆ°ÁêÜÈñ¢Êï∞
       */
      function showLoading(show) {
        loading.classList.toggle("show", show);
        extractBtn.disabled = show;
        if (show) {
          noData.style.display = "none";
        }
      }

      function showControls(show) {
        controls.classList.toggle("show", show);
        if (!show) {
          noData.style.display = imageData.length === 0 ? "block" : "none";
        } else {
          noData.style.display = "none";
        }
      }

      function showError(message) {
        showMessage(message, "error");
      }

      function showSuccess(message) {
        showMessage(message, "success");
      }

      function showWarning(message) {
        showMessage(message, "warning");
      }

      function showMessage(message, type) {
        const messageEl = document.createElement("div");
        messageEl.className = `${type}-message`;
        messageEl.textContent = message;

        const container = document.querySelector(".container");
        const urlSection = document.querySelector(".url-section");
        container.insertBefore(messageEl, urlSection.nextSibling);

        setTimeout(() => messageEl.remove(), 5000);
      }
    </script>
  </body>
</html>
