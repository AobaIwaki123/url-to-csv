<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV Image Checker - ç”»åƒãƒã‚§ãƒƒã‚¯ãƒ„ãƒ¼ãƒ«</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        text-align: center;
        margin-bottom: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .upload-section {
        background: white;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        cursor: pointer;
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
        padding: 12px 24px;
        border-radius: 5px;
        transition: all 0.3s ease;
        font-weight: bold;
      }

      .file-input-wrapper:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      #csvFile {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .controls {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: linear-gradient(45deg, #2196f3, #1976d2);
        color: white;
      }

      .btn-success {
        background: linear-gradient(45deg, #4caf50, #45a049);
        color: white;
      }

      .btn-warning {
        background: linear-gradient(45deg, #ff9800, #f57c00);
        color: white;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .stats {
        display: flex;
        gap: 2rem;
        font-size: 1.1rem;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .stat-number {
        font-weight: bold;
        font-size: 1.3rem;
        color: #667eea;
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-top: 2rem;
      }

      .image-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      }

      .image-card.excluded {
        opacity: 0.6;
        background: #f8f8f8;
      }

      .image-preview {
        width: 100%;
        height: 200px;
        object-fit: contain;
        background: #f0f0f0;
        border-bottom: 1px solid #eee;
      }

      .image-preview.error {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 0.9rem;
        background: #f8f8f8;
      }

      .image-info {
        padding: 1rem;
      }

      .image-name-input {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        margin-bottom: 1rem;
        transition: border-color 0.3s ease;
      }

      .image-name-input:focus {
        outline: none;
        border-color: #667eea;
      }

      .image-url {
        font-size: 0.8rem;
        color: #666;
        word-break: break-all;
        margin-bottom: 1rem;
        line-height: 1.4;
      }

      .exclude-checkbox {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: bold;
      }

      .exclude-checkbox input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 2rem;
        font-size: 1.2rem;
        color: #667eea;
      }

      .no-data {
        text-align: center;
        padding: 4rem 2rem;
        color: #999;
        font-size: 1.2rem;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #c62828;
      }

      .success-message {
        background: #e8f5e8;
        color: #2e7d32;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
        border-left: 4px solid #2e7d32;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        h1 {
          font-size: 2rem;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        .stats {
          flex-direction: column;
          gap: 1rem;
        }

        .image-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ğŸ“· CSV Image Checker</h1>
        <p class="subtitle">Net2Sheet CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ç”»åƒãƒã‚§ãƒƒã‚¯ï¼†ç·¨é›†ãƒ„ãƒ¼ãƒ«</p>
      </header>

      <div class="upload-section">
        <h2>ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h2>
        <p style="margin-bottom: 1rem; color: #666">
          Net2Sheetæ‹¡å¼µã§ç”Ÿæˆã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
          ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ï¼šã€Œãƒ•ã‚¡ã‚¤ãƒ«åã€,ã€ŒURLã€
        </p>
        <div class="file-input-wrapper">
          <input type="file" id="csvFile" accept=".csv" />
          ğŸ“„ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
        </div>
      </div>

      <div class="controls" style="display: none" id="controls">
        <div class="stats">
          <div class="stat-item">
            <span>ğŸ“Š ç·æ•°:</span>
            <span class="stat-number" id="totalCount">0</span>
          </div>
          <div class="stat-item">
            <span>âœ… æœ‰åŠ¹:</span>
            <span class="stat-number" id="validCount">0</span>
          </div>
          <div class="stat-item">
            <span>âŒ é™¤å¤–:</span>
            <span class="stat-number" id="excludedCount">0</span>
          </div>
        </div>
        <div>
          <button class="btn btn-warning" id="toggleExcluded">
            ğŸ‘ï¸ é™¤å¤–ç”»åƒã‚’éš ã™/è¡¨ç¤º
          </button>
          <button class="btn btn-success" id="exportCsv">
            ğŸ’¾ ä¿®æ­£ç‰ˆCSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
        </div>
      </div>

      <div class="loading" id="loading">ğŸ”„ ç”»åƒã‚’èª­ã¿è¾¼ã¿ä¸­...</div>

      <div class="no-data" id="noData">
        ğŸ“‹ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã¨ã€ç”»åƒä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
      </div>

      <div class="image-grid" id="imageGrid"></div>
    </div>

    <script>
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
      let imageData = [];
      let showExcluded = true;

      // DOMè¦ç´ ã®å–å¾—
      const csvFileInput = document.getElementById("csvFile");
      const controls = document.getElementById("controls");
      const loading = document.getElementById("loading");
      const noData = document.getElementById("noData");
      const imageGrid = document.getElementById("imageGrid");
      const totalCount = document.getElementById("totalCount");
      const validCount = document.getElementById("validCount");
      const excludedCount = document.getElementById("excludedCount");
      const toggleExcludedBtn = document.getElementById("toggleExcluded");
      const exportCsvBtn = document.getElementById("exportCsv");

      // CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆ
      csvFileInput.addEventListener("change", handleFileSelect);
      toggleExcludedBtn.addEventListener("click", toggleExcludedImages);
      exportCsvBtn.addEventListener("click", exportModifiedCsv);

      /**
       * CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
       */
      async function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.name.toLowerCase().endsWith(".csv")) {
          showError("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        try {
          showLoading(true);
          const csvText = await readFileAsText(file);
          const parsedData = parseCSV(csvText);

          if (parsedData.length === 0) {
            showError("CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
            return;
          }

          imageData = parsedData.map((row, index) => ({
            id: index,
            originalName: row[0] || "",
            editedName: row[0] || "",
            url: row[1] || "",
            excluded: false,
          }));

          await renderImages();
          updateStats();
          showControls(true);
          showSuccess(`${imageData.length}ä»¶ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`);
        } catch (error) {
          showError(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        } finally {
          showLoading(false);
        }
      }

      /**
       * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
       */
      function readFileAsText(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = () =>
            reject(new Error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
          reader.readAsText(file, "UTF-8");
        });
      }

      /**
       * CSVè§£æï¼ˆç°¡æ˜“ç‰ˆï¼‰
       */
      function parseCSV(csvText) {
        const lines = csvText.trim().split("\n");
        const data = [];

        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã€Œãƒ•ã‚¡ã‚¤ãƒ«åã€,ã€ŒURLã€ï¼‰
        const startIndex =
          lines[0].includes("ãƒ•ã‚¡ã‚¤ãƒ«å") || lines[0].includes("Filename")
            ? 1
            : 0;

        for (let i = startIndex; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          // ç°¡æ˜“CSVè§£æï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
          const row = parseCSVLine(line);
          if (row.length >= 2) {
            data.push(row);
          }
        }

        return data;
      }

      /**
       * CSVè¡Œè§£æï¼ˆã‚¯ã‚©ãƒ¼ãƒˆå¯¾å¿œï¼‰
       */
      function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;
        let i = 0;

        while (i < line.length) {
          const char = line[i];

          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸã‚¯ã‚©ãƒ¼ãƒˆ
              current += '"';
              i += 2;
            } else {
              // ã‚¯ã‚©ãƒ¼ãƒˆã®é–‹å§‹/çµ‚äº†
              inQuotes = !inQuotes;
              i++;
            }
          } else if (char === "," && !inQuotes) {
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åŒºåˆ‡ã‚Š
            result.push(current);
            current = "";
            i++;
          } else {
            current += char;
            i++;
          }
        }

        result.push(current);
        return result;
      }

      /**
       * ç”»åƒä¸€è¦§è¡¨ç¤º
       */
      async function renderImages() {
        imageGrid.innerHTML = "";

        const visibleImages = imageData.filter(
          (img) => showExcluded || !img.excluded
        );

        if (visibleImages.length === 0) {
          imageGrid.innerHTML =
            '<div class="no-data">è¡¨ç¤ºã™ã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }

        for (const img of visibleImages) {
          const card = createImageCard(img);
          imageGrid.appendChild(card);
        }
      }

      /**
       * ç”»åƒã‚«ãƒ¼ãƒ‰ä½œæˆ
       */
      function createImageCard(img) {
        const card = document.createElement("div");
        card.className = `image-card ${img.excluded ? "excluded" : ""}`;
        card.dataset.id = img.id;

        card.innerHTML = `
                <div class="image-preview-container">
                    <img class="image-preview" src="${img.url}" alt="${
          img.editedName
        }"
                         onerror="this.className='image-preview error'; this.innerHTML='ğŸ–¼ï¸ ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“';" />
                </div>
                <div class="image-info">
                    <input type="text" class="image-name-input" value="${escapeHtml(
                      img.editedName
                    )}" 
                           placeholder="ç”»åƒåã‚’å…¥åŠ›..." data-id="${img.id}" />
                    <div class="image-url">${escapeHtml(img.url)}</div>
                    <label class="exclude-checkbox">
                        <input type="checkbox" ${
                          img.excluded ? "checked" : ""
                        } data-id="${img.id}" />
                        ğŸš« ã“ã®ç”»åƒã‚’é™¤å¤–ã™ã‚‹
                    </label>
                </div>
            `;

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
        const nameInput = card.querySelector(".image-name-input");
        const excludeCheckbox = card.querySelector('input[type="checkbox"]');

        nameInput.addEventListener("input", (e) => {
          const imgId = parseInt(e.target.dataset.id);
          const imgItem = imageData.find((item) => item.id === imgId);
          if (imgItem) {
            imgItem.editedName = e.target.value;
          }
        });

        excludeCheckbox.addEventListener("change", (e) => {
          const imgId = parseInt(e.target.dataset.id);
          const imgItem = imageData.find((item) => item.id === imgId);
          if (imgItem) {
            imgItem.excluded = e.target.checked;
            card.className = `image-card ${imgItem.excluded ? "excluded" : ""}`;
            updateStats();
          }
        });

        return card;
      }

      /**
       * çµ±è¨ˆæƒ…å ±æ›´æ–°
       */
      function updateStats() {
        const total = imageData.length;
        const excluded = imageData.filter((img) => img.excluded).length;
        const valid = total - excluded;

        totalCount.textContent = total;
        validCount.textContent = valid;
        excludedCount.textContent = excluded;
      }

      /**
       * é™¤å¤–ç”»åƒã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
       */
      async function toggleExcludedImages() {
        showExcluded = !showExcluded;
        toggleExcludedBtn.textContent = showExcluded
          ? "ğŸ‘ï¸ é™¤å¤–ç”»åƒã‚’éš ã™"
          : "ğŸ‘ï¸ é™¤å¤–ç”»åƒã‚’è¡¨ç¤º";
        await renderImages();
      }

      /**
       * ä¿®æ­£ç‰ˆCSVå‡ºåŠ›
       */
      function exportModifiedCsv() {
        const validImages = imageData.filter((img) => !img.excluded);

        if (validImages.length === 0) {
          showError("å‡ºåŠ›ã™ã‚‹ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        try {
          // CSVç”Ÿæˆ
          const csvContent = generateCSV(validImages);
          const filename = generateCSVFilename("modified_images");

          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
          downloadCSV(csvContent, filename);
          showSuccess(
            `ä¿®æ­£ç‰ˆCSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸã€‚\nãƒ•ã‚¡ã‚¤ãƒ«å: ${filename}\nä»¶æ•°: ${validImages.length}ä»¶`
          );
        } catch (error) {
          showError(`CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      }

      /**
       * CSVç”Ÿæˆï¼ˆNet2Sheetå½¢å¼ã«åˆã‚ã›ã‚‹ï¼‰
       */
      function generateCSV(images) {
        const headers = ["ãƒ•ã‚¡ã‚¤ãƒ«å", "URL"];
        const rows = [csvRow(headers)];

        images.forEach((img) => {
          rows.push(csvRow([img.editedName, img.url]));
        });

        return rows.join("\n");
      }

      /**
       * CSVè¡Œç”Ÿæˆï¼ˆã‚¯ã‚©ãƒ¼ãƒˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å¯¾å¿œï¼‰
       */
      function csvRow(row) {
        return row
          .map((value) => `"${(value || "").replace(/"/g, '""')}"`)
          .join(",");
      }

      /**
       * CSVãƒ•ã‚¡ã‚¤ãƒ«åç”Ÿæˆ
       */
      function generateCSVFilename(prefix = "modified_images") {
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/[T:]/g, "_");
        return `${prefix}_${timestamp}.csv`;
      }

      /**
       * CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
       */
      function downloadCSV(csvContent, filename) {
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      /**
       * HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
       */
      function escapeHtml(unsafe) {
        return (unsafe || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      /**
       * UIçŠ¶æ…‹ç®¡ç†é–¢æ•°
       */
      function showLoading(show) {
        loading.style.display = show ? "block" : "none";
        noData.style.display = show
          ? "none"
          : !imageData.length
          ? "block"
          : "none";
      }

      function showControls(show) {
        controls.style.display = show ? "flex" : "none";
        noData.style.display = show ? "none" : "block";
      }

      function showError(message) {
        const error = document.createElement("div");
        error.className = "error-message";
        error.textContent = message;
        document.querySelector(".container").insertBefore(error, controls);
        setTimeout(() => error.remove(), 5000);
      }

      function showSuccess(message) {
        const success = document.createElement("div");
        success.className = "success-message";
        success.textContent = message;
        document.querySelector(".container").insertBefore(success, controls);
        setTimeout(() => success.remove(), 5000);
      }
    </script>
  </body>
</html>
